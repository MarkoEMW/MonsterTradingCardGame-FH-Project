<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERC20 Token Transfer</title>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            margin-top: 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 20px;
            font-size: 18px;
            padding: 10px;
            border-radius: 4px;
        }
        .status {
            margin-top: 10px;
            color: #666;
        }
        .token-info {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: inline-block;
            text-align: left;
        }
        .transfer-details {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: left;
            background-color: #f9f9f9;
        }
        .tx-hash {
            word-break: break-all;
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>ERC20 Token Transfer</h1>
    
    <div class="status" id="status">Loading ethers.js...</div>
    <div class="token-info">
        <div id="tokenName">Token Name: Loading...</div>
        <div id="tokenSymbol">Symbol: Loading...</div>
        <div id="tokenDecimals">Decimals: Loading...</div>
        <div id="accountBalance">Your Balance: Loading...</div>
    </div>
    
    <div class="transfer-details">
        <h3>Transfer Details</h3>
        <p><strong>Recipient Address:</strong> 0x15433DA387451F9dE4565280C85506CB71aF9376</p>
        <p><strong>Amount to Transfer:</strong> 10 tokens</p>
    </div>

    <button id="transferTokens" disabled>Transfer 10 Tokens</button>
    
    <div id="result"></div>
    
    <script>
        const contractAddress = "0x561a780944d66c7441c5f766a70030da1d261d9e"; 
        const recipientAddress = "0x15433DA387451F9dE4565280C85506CB71aF9376"; 
        const transferAmount = 10;
        
        const contractABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function transfer(address to, uint256 amount) returns (bool)"
        ];
        
        const checkEthers = () => {
            const statusDiv = document.getElementById('status');
            const button = document.getElementById('transferTokens');
            
            if (typeof ethers === 'undefined') {
                statusDiv.innerHTML = "Failed to load ethers.js library. Please check your internet connection.";
                statusDiv.style.color = "red";
                return false;
            }
            
            console.log("Ethers version:", ethers.version);
            statusDiv.innerHTML = "Ethers.js loaded successfully. Checking for MetaMask...";
            
            setTimeout(() => {
                if (window.ethereum) {
                    statusDiv.innerHTML = "MetaMask detected!";
                    statusDiv.style.color = "green";
                    button.disabled = false;
                } else {
                    statusDiv.innerHTML = "MetaMask not detected. Please install MetaMask extension.";
                    statusDiv.style.color = "red";
                }
            }, 1000);
            
            return true;
        };
        
        const formatAddress = (address) => {
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        };
        

        async function getTokenInfo(contract, userAddress) {
            try {
                console.log("Getting token info from contract:", contract.address);
                const name = await contract.name();
                console.log("Token name:", name);
                const symbol = await contract.symbol();
                console.log("Token symbol:", symbol);
                const decimals = await contract.decimals();
                console.log("Token decimals:", decimals);
                
                document.getElementById('tokenName').textContent = `Token Name: ${name}`;
                document.getElementById('tokenSymbol').textContent = `Symbol: ${symbol}`;
                document.getElementById('tokenDecimals').textContent = `Decimals: ${decimals}`;
                

                if (userAddress) {
                    const balance = await contract.balanceOf(userAddress);
                    const formattedBalance = ethers.utils.formatUnits(balance, decimals);
                    document.getElementById('accountBalance').textContent = 
                        `Your Balance: ${formattedBalance} ${symbol} (${formatAddress(userAddress)})`;
                    console.log("User balance:", formattedBalance, symbol);
                }
                
                return { name, symbol, decimals };
            } catch (error) {
                console.error("Error getting token info:", error);
                document.getElementById('tokenName').textContent = "Token Name: Error fetching";
                document.getElementById('tokenSymbol').textContent = "Symbol: Error fetching";
                document.getElementById('tokenDecimals').textContent = "Decimals: Error fetching";
                document.getElementById('accountBalance').textContent = "Your Balance: Error fetching";
                return { name: "Unknown", symbol: "Unknown", decimals: 18 };
            }
        }
        

        window.onload = function() {
            const ethersLoaded = checkEthers();
            if (!ethersLoaded) return;
            
            const transferButton = document.getElementById('transferTokens');
            const resultDiv = document.getElementById('result');
            
            transferButton.addEventListener('click', async function() {
                resultDiv.innerHTML = "Connecting to MetaMask...";
                
                try {

                    if (!window.ethereum) {
                        throw new Error("MetaMask is not installed! Please install MetaMask to continue.");
                    }
                    
                    console.log("Creating Web3Provider with ethereum:", window.ethereum);
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    

                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const accounts = await provider.listAccounts();
                    console.log("Connected accounts:", accounts);
                    
                    if (accounts.length === 0) {
                        throw new Error("No accounts found. Please unlock MetaMask.");
                    }
                    
                    const userAddress = accounts[0];
                    resultDiv.innerHTML = "Connected! Checking network...";
                    
 
                    const network = await provider.getNetwork();
                    console.log("Current network:", network);
                    
                    if (network.chainId !== 17000) {
                        resultDiv.innerHTML = "Switching to Holesky network...";
                        
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x4268' }], 
                            });
                            
                            location.reload();
                            return;
                        } catch (switchError) {
                            console.error("Switch error:", switchError);
                            
                            if (switchError.code === 4902) {
                                resultDiv.innerHTML = "Adding Holesky network to MetaMask...";
                                
                                try {
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: '0x4268',
                                            chainName: 'Holesky Testnet',
                                            nativeCurrency: {
                                                name: 'Holesky ETH',
                                                symbol: 'ETH',
                                                decimals: 18
                                            },
                                            rpcUrls: ['https://ethereum-holesky.publicnode.com'],
                                            blockExplorerUrls: ['https://holesky.etherscan.io']
                                        }]
                                    });
                                    
                                    // Reload after adding network
                                    location.reload();
                                    return;
                                } catch (addError) {
                                    throw new Error('Error adding Holesky network: ' + addError.message);
                                }
                            } else {
                                throw new Error('Error switching to Holesky network: ' + switchError.message);
                            }
                        }
                    }
                    
                    resultDiv.innerHTML = "Initializing contract...";
                    
                    const readContract = new ethers.Contract(
                        contractAddress,
                        contractABI,
                        provider
                    );
                    
                    const tokenInfo = await getTokenInfo(readContract, userAddress);
                    
                    const signer = provider.getSigner();
                    const tokenContract = new ethers.Contract(
                        contractAddress,
                        contractABI,
                        signer
                    );
                    

                    const amount = ethers.utils.parseUnits(transferAmount.toString(), tokenInfo.decimals);
                    

                    resultDiv.innerHTML = `Preparing to transfer ${transferAmount} ${tokenInfo.symbol} to ${formatAddress(recipientAddress)}.<br>Please confirm the transaction in MetaMask...`;

                    const currentBalance = await readContract.balanceOf(userAddress);
                    console.log("Current balance:", ethers.utils.formatUnits(currentBalance, tokenInfo.decimals), tokenInfo.symbol);
                    
                    if (currentBalance.lt(amount)) {
                        throw new Error(`Insufficient token balance. You need ${transferAmount} ${tokenInfo.symbol} but only have ${ethers.utils.formatUnits(currentBalance, tokenInfo.decimals)} ${tokenInfo.symbol}`);
                    }
                    

                    const gasEstimate = await tokenContract.estimateGas.transfer(recipientAddress, amount).catch(error => {
                        console.error("Gas estimation failed:", error);

                        return ethers.BigNumber.from(100000);
                    });
                    
                    console.log("Gas estimate:", gasEstimate.toString());
                    

                    const tx = await tokenContract.transfer(recipientAddress, amount, {
                        gasLimit: gasEstimate.mul(ethers.BigNumber.from(2))
                    });
                    
                    resultDiv.innerHTML = `Transaction submitted! Waiting for confirmation...<br><span class="tx-hash">Transaction hash: ${tx.hash}</span>`;
                    
                    await tx.wait();
                    
                    resultDiv.innerHTML = `
                        <p style="color: green;">✓ Transfer successful!</p>
                        <p>Transferred ${transferAmount} ${tokenInfo.symbol} to ${formatAddress(recipientAddress)}</p>
                        <p class="tx-hash">Transaction hash: ${tx.hash}</p>
                        <p><a href="https://holesky.etherscan.io/tx/${tx.hash}" target="_blank">View on Etherscan</a></p>
                    `;
                    

                    setTimeout(async () => {
                        try {
                            const newBalance = await readContract.balanceOf(userAddress);
                            const formattedBalance = ethers.utils.formatUnits(newBalance, tokenInfo.decimals);
                            document.getElementById('accountBalance').textContent = 
                                `Your Balance: ${formattedBalance} ${tokenInfo.symbol} (${formatAddress(userAddress)})`;
                        } catch (err) {
                            console.error("Error updating balance:", err);
                        }
                    }, 2000);
                    
                } catch (error) {
                    console.error("Error:", error);
                    resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                    
                    if (error.code === 4001) {
                        resultDiv.innerHTML += "<p>Transaction was rejected by the user.</p>";
                    } else if (error.message.includes("insufficient funds")) {
                        resultDiv.innerHTML += "<p>You may not have enough tokens in your account or ETH for gas.</p>";
                    }
                }
            });
            
            setTimeout(async () => {
                try {
                    if (window.ethereum) {
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        
                        let accounts = [];
                        try {
                            accounts = await provider.listAccounts();
                        } catch (e) {
                            console.log("User has not connected accounts yet");
                        }
                        
                        const network = await provider.getNetwork();
                        console.log("Initial network check:", network);
                        
                        if (network.chainId === 17000) {
                            const tokenContract = new ethers.Contract(
                                contractAddress,
                                contractABI,
                                provider
                            );
                            
                            const userAddress = accounts.length > 0 ? accounts[0] : null;
                            await getTokenInfo(tokenContract, userAddress);
                        } else {
                            document.getElementById('tokenName').textContent = "Token Name: Please connect to Holesky";
                            document.getElementById('tokenSymbol').textContent = "Symbol: Please connect to Holesky";
                            document.getElementById('tokenDecimals').textContent = "Decimals: Please connect to Holesky";
                        }
                    }
                } catch (e) {
                    console.log("Could not get initial token info:", e);
                }
            }, 1500);
        };
        
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                console.log('Network changed, reloading...');
                window.location.reload();
            });
            
            window.ethereum.on('accountsChanged', () => {
                console.log('Account changed, reloading...');
                window.location.reload();
            });
        }
    </script>
</body>
</html>